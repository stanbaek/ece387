
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>üî¨ Lab7: Transformation &#8212; Introduction to Robotic Systems</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Labs/Lab7_TF';</script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="üî¨ Lab 8: LiDAR" href="Lab8_LIDAR.html" />
    <link rel="prev" title="üî¨ Lab6: IMU-Based Navigation" href="Lab6_IMU.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/ece387.png" class="logo__image only-light" alt="Introduction to Robotic Systems - Home"/>
    <script>document.write(`<img src="../_static/ece387.png" class="logo__image only-dark" alt="Introduction to Robotic Systems - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    ECE 387 Introduction to Robotic Systems
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Info</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../syllabus.html">üìå Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schedule.html">üìÜ Course Schedule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PythonBasic.html">üêç Python Basic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PythonIntermediate.html">üêç Python Intermediate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NumPy.html">‚ûï NumPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">üôã FAQ</a></li>
<li class="toctree-l1"><a class="reference external" href="https://stanbaek.github.io/NoPointer.html">No Pointers in Python?</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Lab1_Linux.html">üî¨ Lab1: Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab2_ROS.html">üî¨ Lab2: ROS</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab3_Python.html">üî¨ Lab3: Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab4_Gamepad.html">üî¨ Lab4: Gamepad</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab5_TurtleBot.html">üî¨ Lab5: Driving the Robot</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab6_IMU.html">üî¨ Lab6: IMU-Based Navigation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">üî¨ Lab7: Transformation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab8_LIDAR.html">üî¨ Lab 8: LiDAR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Appendix/RobotSetup.html">üîß Robot Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendix/MasterSetup.html">üîß Master Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendix/GitSetup.html">üîß Git Repo Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendix/GamepadSetup.html">üîß Gamepad Setup</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/stanbaek/ece387" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/stanbaek/ece387/issues/new?title=Issue%20on%20page%20%2FLabs/Lab7_TF.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Labs/Lab7_TF.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>üî¨ Lab7: Transformation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objectives">üìå Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">üìú Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-lab-testing-the-imu">üå± Pre-Lab: Testing the IMU</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-interactive-ssh-sessions">Non-Interactive SSH Sessions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-robot-launch-py-without-ssh-into-the-robot">Running <code class="docutils literal notranslate"><span class="pre">robot.launch.py</span></code> without SSH into the Robot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lab-procedure">üíª Lab Procedure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-new-ros2-package"><strong>Creating a New ROS2 Package</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-service-server"><strong>Implementing the Service Server</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-service-client"><strong>Implementing the Service Client</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-coordinate-transformation"><strong>Implement Coordinate Transformation</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-and-test-the-package"><strong>Build and Test the Package</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deliverables">üöö Deliverables</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab7-transformation">
<h1>üî¨ Lab7: Transformation<a class="headerlink" href="#lab7-transformation" title="Link to this heading">#</a></h1>
<section id="objectives">
<h2>üìå Objectives<a class="headerlink" href="#objectives" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Students should be able to explain the concept of coordinate transformation between global and local frames.</p></li>
<li><p>Students should be able to implement a method to reset local coordinates without restarting the TurtleBot3.</p></li>
<li><p>Students should be able to apply the rotational transformation matrix to convert coordinates between different frames.</p></li>
<li><p>Students should be able to utilize IMU and odometry sensor data to determine the robot‚Äôs pose.</p></li>
<li><p>Students should be able to develop and test a ROS2 service to reset the TurtleBot3‚Äôs pose programmatically.</p></li>
<li><p>Students should be able to debug and troubleshoot coordinate transformation issues in a real-world robotic system.</p></li>
</ul>
</section>
<section id="overview">
<h2>üìú Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>In this lab, we will learn how to transform coordinates from the global coordinate system to the local coordinate system. When you power on the TurtleBot3, its initial position and orientation (pose) are automatically set to zero. However, if you want to start a new task after completing a previous one, the initial pose will no longer be zero.</p>
<p>To reset the pose, you could power-cycle the robot or press the reset button on the OpenCR board, but this also requires restarting <code class="docutils literal notranslate"><span class="pre">bringup</span></code>, which is not always convenient. Instead, we will implement a method to reset the local coordinates without having to restart the board.</p>
<a class="reference internal image-reference" href="../_images/Lab7_CoordTransformation.png"><img alt="../_images/Lab7_CoordTransformation.png" class="align-center" src="../_images/Lab7_CoordTransformation.png" style="width: 300px;" />
</a>
<p>As discussed in the lecture, a coordinate transformation allows us to express a point‚Äôs position in one frame relative to another. The rotational matrix that rotates Frame {B} with respect to Frame {A} by an angle <span class="math notranslate nohighlight">\(\theta\)</span> in a 2D space is given by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}{}^{A}R_B = \begin{bmatrix} \cos\theta &amp; -\sin\theta \\ \sin\theta &amp; \cos\theta \end{bmatrix} \end{split}\]</div>
<p>Using this transformation, a position <span class="math notranslate nohighlight">\(\mathbf{p}\)</span> in the figure above can be represented in both Frame {A} (the global frame) and Frame {B} (the local frame). The coordinate transformation equation is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix} {}^{A}x \\ {}^{A}y \end{bmatrix} = {}^{A}R_B  \begin{bmatrix} {}^{B}x \\ {}^{B}y \end{bmatrix} + \begin{bmatrix} x \\ y \end{bmatrix} \end{split}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\([{}^{A}x \quad {}^{A}y]^\top\)</span> represents the position in the global frame, measured by the TurtleBot‚Äôs IMU and odometry sensors.</p></li>
<li><p><span class="math notranslate nohighlight">\([{}^{B}x \quad {}^{B}y]^\top\)</span> represents the position in the local frame, which we aim to determine.</p></li>
<li><p><span class="math notranslate nohighlight">\(\theta\)</span> is the orientation of Frame {B} relative to Frame {A}.</p></li>
<li><p><span class="math notranslate nohighlight">\([x \quad y]^\top\)</span> represents the displacement between Frame {A} and Frame {B}.</p></li>
</ul>
<p>To find the local coordinates <span class="math notranslate nohighlight">\([{}^{B}x \quad {}^{B}y]^\top\)</span>, we rearrange the equation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix} {}^{B}x \\ {}^{B}y \end{bmatrix} = {}^{A}R_B^{-1} \left(\begin{bmatrix} {}^{A}x \\ {}^{A}y \end{bmatrix} - \begin{bmatrix} x \\ y \end{bmatrix}\right)\end{split}\]</div>
<p>The orientation with respect to Frame {B}, <span class="math notranslate nohighlight">\({}^{B}\theta\)</span>, can be obtained by <span class="math notranslate nohighlight">\({}^{B}\theta = {}^{A}\theta - \theta\)</span> as illustrated in the figure below</p>
<a class="reference internal image-reference" href="../_images/Lab7_Orientation.png"><img alt="../_images/Lab7_Orientation.png" class="align-center" src="../_images/Lab7_Orientation.png" style="width: 300px;" />
</a>
<p>This transformation allows us to reset the local coordinates programmatically rather than manually restarting the TurtleBot3, making our system more efficient and flexible.</p>
</section>
<section id="pre-lab-testing-the-imu">
<h2>üå± Pre-Lab: Testing the IMU<a class="headerlink" href="#pre-lab-testing-the-imu" title="Link to this heading">#</a></h2>
<section id="non-interactive-ssh-sessions">
<h3>Non-Interactive SSH Sessions<a class="headerlink" href="#non-interactive-ssh-sessions" title="Link to this heading">#</a></h3>
<p>Sometimes, we need to execute commands remotely without logging into the remote host via SSH. Here‚Äôs how you can run commands remotely from your local computer:</p>
<ol class="arabic">
<li><p>Run the following command on your master computer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>pi@robotX<span class="w"> </span><span class="s1">&#39;ls -la&#39;</span>
</pre></div>
</div>
<p>Here, X is the number assigned to your robot. This command will display the files and directories in the <code class="docutils literal notranslate"><span class="pre">pi</span></code> user‚Äôs home directory, allowing us to execute commands on the remote computer without actually logging into it.</p>
</li>
<li><p>Try running this command next:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>pi@robotX<span class="w"> </span><span class="s1">&#39;echo $ROS_DOMAIN_ID&#39;</span>
</pre></div>
</div>
<p>You may notice that it returns an empty string, even though we have already defined <code class="docutils literal notranslate"><span class="pre">ROS_DOMAIN_ID</span></code> inside the <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file. To verify it‚Äôs defined correctly, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>pi@robotX<span class="w"> </span><span class="s1">&#39;cat ~/.bashrc&#39;</span>
</pre></div>
</div>
<p>Look for the line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">ROS_DOMAIN_ID</span><span class="o">=</span><span class="m">99</span>
</pre></div>
</div>
<p>It confirms that <code class="docutils literal notranslate"><span class="pre">ROS_DOMAIN_ID</span></code> is defined correctly in the <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file.</p>
</li>
<li><p>At the beginning of the <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file, you will find the following lines:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># If not running interactively, don&#39;t do anything</span>
<span class="k">case</span><span class="w"> </span><span class="nv">$-</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>*i*<span class="o">)</span><span class="w"> </span><span class="p">;;</span>
<span class="w">      </span>*<span class="o">)</span><span class="w"> </span><span class="k">return</span><span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</div>
<p>This code prevents the <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file from executing if the shell is not in interactive mode. Since our <code class="docutils literal notranslate"><span class="pre">ssh</span></code> command runs in non-interactive mode, this code skips the rest of the <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file. When you log into the host computer via SSH, the shell is in interactive mode, and all commands are executed normally.</p>
</li>
<li><p>Open Visual Studio Code (<code class="docutils literal notranslate"><span class="pre">VS</span> <span class="pre">Code</span></code>) and click on the <code class="docutils literal notranslate"><span class="pre">Extensions</span></code> icon on the left sidebar or press <code class="docutils literal notranslate"><span class="pre">Ctrl+Shift+X</span></code>. Type <code class="docutils literal notranslate"><span class="pre">remote</span></code> and select <code class="docutils literal notranslate"><span class="pre">Remote-SSH</span></code>. Install it if it‚Äôs not already installed.</p></li>
<li><p>Open the Command Palette by pressing <code class="docutils literal notranslate"><span class="pre">Ctrl+Shift+P</span></code> or navigating to <code class="docutils literal notranslate"><span class="pre">View</span> <span class="pre">&gt;</span> <span class="pre">Command</span> <span class="pre">Palette</span></code>. Type the first few letters of <code class="docutils literal notranslate"><span class="pre">Remote-SSH</span></code> and select <code class="docutils literal notranslate"><span class="pre">Remote-SSH:</span> <span class="pre">Connect</span> <span class="pre">to</span> <span class="pre">Host</span></code>. Enter <code class="docutils literal notranslate"><span class="pre">pi&#64;robotX</span></code> and hit Enter. Type the password if prompted, though it should be password-free if you‚Äôve set up an SSH key. It may take a couple of minutes to set up the <code class="docutils literal notranslate"><span class="pre">vscode</span> <span class="pre">server</span></code> on the remote computer for the first time.</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Explorer</span></code> on the left sidebar, choose <code class="docutils literal notranslate"><span class="pre">/home/pi</span></code> for the <code class="docutils literal notranslate"><span class="pre">Open</span> <span class="pre">Folder</span></code> option, and hit OK. You should now see all the files in the home directory. Click on <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> to open it. Replace the following lines:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># If not running interactively, don&#39;t do anything</span>
<span class="k">case</span><span class="w"> </span><span class="nv">$-</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>*i*<span class="o">)</span><span class="w"> </span><span class="p">;;</span>
<span class="w">      </span>*<span class="o">)</span><span class="w"> </span><span class="k">return</span><span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</div>
<p>with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># If not running interactively, set the following environment variables</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$-</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span>*i*<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span>/opt/ros/humble/setup.bash
<span class="w">    </span><span class="nb">source</span><span class="w"> </span>~/robot_ws/install/setup.bash
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">TURTLEBOT3_MODEL</span><span class="o">=</span>burger
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">ROS_DOMAIN_ID</span><span class="o">=</span><span class="m">98</span><span class="w">     </span><span class="c1"># TURTLEBOT3</span>
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">LDS_MODEL</span><span class="o">=</span>LDS-02
<span class="w">    </span><span class="k">return</span>
<span class="k">fi</span>
</pre></div>
</div>
<p>Ensure that <code class="docutils literal notranslate"><span class="pre">ROS_DOMAIN_ID=98</span></code> is set with your domain ID. Save the file.</p>
</li>
<li><p>On a terminal, try:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>pi@robotX<span class="w"> </span><span class="s1">&#39;echo $ROS_DOMAIN_ID&#39;</span>
</pre></div>
</div>
<p>It should now return your domain ID.</p>
</li>
</ol>
</section>
<section id="running-robot-launch-py-without-ssh-into-the-robot">
<h3>Running <code class="docutils literal notranslate"><span class="pre">robot.launch.py</span></code> without SSH into the Robot<a class="headerlink" href="#running-robot-launch-py-without-ssh-into-the-robot" title="Link to this heading">#</a></h3>
<p>Previously, to drive a physical TurtleBot3, we had to log into the remote host using SSH and run <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">launch</span> <span class="pre">turtlebot3_bringup</span> <span class="pre">robot.launch.py</span></code>. Here, we will implement a more convenient method to accomplish the same task without logging into the remote computer:</p>
<ol class="arabic">
<li><p>On a terminal, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>pi@robotX<span class="w"> </span><span class="s1">&#39;ros2 launch turtlebot3_bringup robot.launch.py&#39;</span>
</pre></div>
</div>
<p>This command remotely starts the <code class="docutils literal notranslate"><span class="pre">robot.launch.py</span></code> script on the TurtleBot3.</p>
</li>
<li><p>To simplify this process, add the following alias to the <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file on your <code class="docutils literal notranslate"><span class="pre">master</span></code> computer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span><span class="w"> </span><span class="nv">bringup</span><span class="o">=</span><span class="s1">&#39;ssh pi@robotX &#39;</span><span class="se">\&#39;</span><span class="s1">&#39;ros2 launch turtlebot3_bringup robot.launch.py&#39;</span><span class="se">\&#39;</span>
</pre></div>
</div>
</li>
<li><p>Apply the changes by sourcing the <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> file or restarting the terminal. Now, simply run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>bringup
</pre></div>
</div>
<p>This alias will allow you to run the <code class="docutils literal notranslate"><span class="pre">robot.launch.py</span></code> script on your TurtleBot3 without needing to log into the remote computer each time.</p>
</li>
<li><p>To verify that the launch file is running correctly, check the active ROS nodes on the <code class="docutils literal notranslate"><span class="pre">master</span></code> computer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ros2<span class="w"> </span>node<span class="w"> </span>list
</pre></div>
</div>
<p>If the expected nodes are running, your setup is correct.</p>
</li>
</ol>
<!--
1. (Optional) If you need to stop the launch file remotely, you can use:
    ```bash
    $ ssh pi@robotX 'pkill -f robot.launch.py'
    ```
    This will terminate the running launch process on the TurtleBot3.
-->
<p>Following these steps will ensure a seamless and efficient workflow for launching ROS2 on your TurtleBot3 without needing manual SSH logins each time.</p>
</section>
</section>
<hr class="docutils" />
<section id="lab-procedure">
<h2>üíª Lab Procedure<a class="headerlink" href="#lab-procedure" title="Link to this heading">#</a></h2>
<section id="creating-a-new-ros2-package">
<h3><strong>Creating a New ROS2 Package</strong><a class="headerlink" href="#creating-a-new-ros2-package" title="Link to this heading">#</a></h3>
<p>Follow these steps to set up a new ROS2 package for this lab:</p>
<ol class="arabic">
<li><p><strong>Navigate to Your Workspace:</strong> Open a terminal and move into the <code class="docutils literal notranslate"><span class="pre">ece387_ws</span></code> directory within your ROS2 workspace:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/master_ws/src/ece387_ws
</pre></div>
</div>
</li>
<li><p><strong>Create a New ROS2 Package:</strong> Use the following command to create a new package named <code class="docutils literal notranslate"><span class="pre">lab7_tf</span></code> with the BSD-3 license:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>pkg<span class="w"> </span>create<span class="w"> </span>--build-type<span class="w"> </span>ament_python<span class="w"> </span>--license<span class="w"> </span>BSD-3-Clause<span class="w"> </span>lab7_tf
</pre></div>
</div>
</li>
<li><p><strong>Copy the <code class="docutils literal notranslate"><span class="pre">move2goal.py</span></code> Script:</strong> Copy the <code class="docutils literal notranslate"><span class="pre">move2goal.py</span></code> file from Lab 6 into the <code class="docutils literal notranslate"><span class="pre">ece387_ws/lab7_tf/lab7_tf/</span></code> directory and rename it to <code class="docutils literal notranslate"><span class="pre">move2goal_tf.py</span></code></p></li>
<li><p><strong>Add Dependencies:</strong> Edit <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> to include the following dependencies:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;depend&gt;</span>rclpy<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>geometry_msgs<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>nav2_msgs<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>sensor_msgs<span class="nt">&lt;/depend&gt;</span>
<span class="nt">&lt;depend&gt;</span>std_srvs<span class="nt">&lt;/depend&gt;</span>
</pre></div>
</div>
</li>
<li><p><strong>Modify <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:</strong> Update the <code class="docutils literal notranslate"><span class="pre">entry_points</span></code> section to include the <code class="docutils literal notranslate"><span class="pre">move2goal_tf</span></code> script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;move2goal_tf = lab7_tf.move2goal_tf:main&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">},</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="implementing-the-service-server">
<h3><strong>Implementing the Service Server</strong><a class="headerlink" href="#implementing-the-service-server" title="Link to this heading">#</a></h3>
<ol class="arabic">
<li><p><strong>Import Required Libraries:</strong>  Open <code class="docutils literal notranslate"><span class="pre">move2goal_tf.py</span></code> and add the following imports:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">std_srvs.srv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nav2_msgs.srv</span><span class="w"> </span><span class="kn">import</span> <span class="n">SetInitialPose</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</pre></div>
</div>
</li>
<li><p><strong>Create a Service Server:</strong> Add the following service server inside the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># TODO: Create a service server that will handle &#39;/set_pose&#39; service requests</span>
 <span class="c1"># - Service type: &#39;SetInitialPose&#39;</span>
 <span class="c1"># - Service name: &#39;/set_pose&#39;</span>
 <span class="c1"># - Callback function: &#39;self.set_pose_callback&#39; to execute when the service is called</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">reset_service</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Update this line.</span>
</pre></div>
</div>
</li>
<li><p><strong>Update Position Variables:</strong> Replace the following lines in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Variables to store the robot&#39;s current position and orientation</span>
<span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>    <span class="c1"># Current x-coordinate</span>
<span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>    <span class="c1"># Current y-coordinate</span>
<span class="bp">self</span><span class="o">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Current orientation (yaw angle in radians)</span>
</pre></div>
</div>
<p>with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Local Position Variables (Start at 0.0, 0.0, 0.0)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">local_x</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="bp">self</span><span class="o">.</span><span class="n">local_y</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="bp">self</span><span class="o">.</span><span class="n">local_yaw</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Variables for previous position to compute displacement</span>
<span class="bp">self</span><span class="o">.</span><span class="n">initial_global_x</span> <span class="o">=</span> <span class="kc">None</span>
<span class="bp">self</span><span class="o">.</span><span class="n">initial_global_y</span> <span class="o">=</span> <span class="kc">None</span>
<span class="bp">self</span><span class="o">.</span><span class="n">initial_global_yaw</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</li>
<li><p><strong>Define the Callback Function:</strong> Implement the service callback function to reset the local pose:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">set_pose_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">SetInitialPose</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Empty</span><span class="o">.</span><span class="n">Response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Empty</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resets the local position coordinates to zero and clears the previous position coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reset the local position coordinates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">local_x</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">local_y</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>

    <span class="c1"># Convert Quaternion to Euler Angles (Extract Yaw)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">w</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_yaw</span> <span class="o">=</span> <span class="n">euler_from_quaternion</span><span class="p">(</span><span class="n">quaternion</span><span class="p">)</span>

    <span class="c1"># Reset the state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;ROTATE_TO_GOAL&quot;</span>

    <span class="c1"># Clear the previous position coordinates</span>
    <span class="c1"># This ensures that any previous position data is discarded</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_yaw</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Log a message to indicate the local position has been reset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Local pose set to x=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">local_x</span><span class="si">}</span><span class="s2">, y=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">local_y</span><span class="si">}</span><span class="s2">, yaw=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">local_yaw</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># Return the response to the service caller</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</li>
<li><p><strong>Test the Service:</strong> First, run the node:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>run<span class="w"> </span>lab7_tf<span class="w"> </span>move2goal_tf
</pre></div>
</div>
<p>Then, in another terminal, call the service:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>service<span class="w"> </span>call<span class="w"> </span>/set_pose<span class="w"> </span>nav2_msgs/srv/SetInitialPose<span class="w"> </span><span class="s2">&quot;{pose: {pose: {pose: {position: {x: 0.0, y: 0.0, z: 0.0}, orientation: {x: 0.0, y: 0.0, z: 0.0, w: 1.0}}}}}&quot;</span>
</pre></div>
</div>
<p>You should see a confirmation message indicating that the local pose has been reset.</p>
</li>
</ol>
</section>
<section id="implementing-the-service-client">
<h3><strong>Implementing the Service Client</strong><a class="headerlink" href="#implementing-the-service-client" title="Link to this heading">#</a></h3>
<ol class="arabic">
<li><p><strong>Modify <code class="docutils literal notranslate"><span class="pre">gamepad.py</span></code>:</strong> Import the required libraries:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">std_srvs.srv</span><span class="w"> </span><span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geometry_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">PoseWithCovarianceStamped</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</pre></div>
</div>
</li>
<li><p><strong>Create a Service Client:</strong> Inside the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, add:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># TODO: Create a service client to call the &#39;/set_pose&#39; service</span>
 <span class="c1"># - Service type: &#39;SetInitialPose&#39;</span>
 <span class="c1"># - Service name: &#39;/set_pose&#39;</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">reset_pose_client</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Update this line</span>
</pre></div>
</div>
</li>
<li><p><strong>Call the Service on Button Press:</strong> Modify <code class="docutils literal notranslate"><span class="pre">joy_callback</span></code> to call the reset function when the Y button is pressed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if button 2 (Y) is pressed to reset the pose</span>
<span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">buttons</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">send_set_pose_request</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Call the reset_pose service</span>
</pre></div>
</div>
</li>
<li><p><strong>Define the Request Function:</strong> Implement <code class="docutils literal notranslate"><span class="pre">send_set_pose_request</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">send_set_pose_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the &#39;reset_pose&#39; service to reset the robot&#39;s pose.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if the service is available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_pose_client</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Service &#39;reset_pose&#39; not available.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Create a request object </span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">SetInitialPose</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">PoseWithCovarianceStamped</span><span class="p">()</span>  

    <span class="c1"># Set Header</span>
    <span class="n">request</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s2">&quot;map&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_msg</span><span class="p">()</span>

    <span class="c1"># TODO: Set Position</span>
    

    <span class="c1"># TODO: Convert Yaw (theta) to Quaternion</span>
    <span class="c1"># z = sin(theta/2), w = cos(theta/2)</span>


    <span class="c1"># TODO: Set Covariance (required by AMCL, small uncertainty such as [0.1]*36)</span>
    

    <span class="c1"># Call the service asynchronously</span>
    <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_pose_client</span><span class="o">.</span><span class="n">call_async</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># Add a callback to handle the service response</span>
    <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_pose_done_callback</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Handle Service Response:</strong> Add the following method to the <code class="docutils literal notranslate"><span class="pre">Gamepad</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">reset_pose_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback function to handle the response from the &#39;reset_pose&#39; service.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if the service call was successful</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pose reset successfully.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Pose reset failed.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service call failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="implement-coordinate-transformation">
<h3><strong>Implement Coordinate Transformation</strong><a class="headerlink" href="#implement-coordinate-transformation" title="Link to this heading">#</a></h3>
<ol class="arabic">
<li><p><strong>Modify the <code class="docutils literal notranslate"><span class="pre">imu_callback</span></code> Method</strong> First, update the <code class="docutils literal notranslate"><span class="pre">imu_callback</span></code> method in the <code class="docutils literal notranslate"><span class="pre">MoveToGoal</span></code> class as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">imu_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imu_msg</span><span class="p">:</span> <span class="n">Imu</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback function for handling control relinquishment messages.</span>
<span class="sd">    Updates local yaw relative to the starting orientation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">imu_msg</span><span class="o">.</span><span class="n">orientation</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">global_yaw</span> <span class="o">=</span> <span class="n">euler_from_quaternion</span><span class="p">([</span><span class="n">q</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">w</span><span class="p">])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_yaw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Store the initial yaw as a reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_yaw</span> <span class="o">=</span> <span class="n">global_yaw</span>
        <span class="k">return</span>  <span class="c1"># Skip first iteration</span>

    <span class="c1"># TODO: Compute local yaw relative to the initial global yaw</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">local_yaw</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</li>
<li><p><strong>Modify the <code class="docutils literal notranslate"><span class="pre">odom_callback</span></code> Method</strong> Update the <code class="docutils literal notranslate"><span class="pre">odom_callback</span></code> method to handle odometry messages and update the local x and y coordinates relative to the starting position:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">odom_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Odometry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback function for handling odometry messages.</span>
<span class="sd">    Updates the local x and y coordinates relative to the starting position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract global x and y coordinates from the odometry message</span>
    <span class="n">global_x</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
    <span class="n">global_y</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>

    <span class="c1"># Check if this is the first iteration (initial global position not set)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Store the initial global position as the reference point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_x</span> <span class="o">=</span> <span class="n">global_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_y</span> <span class="o">=</span> <span class="n">global_y</span>
        <span class="c1"># Skip processing for the first iteration</span>
        <span class="k">return</span>

    <span class="c1"># TODO: Compute the displacement of the global position from the initial global position</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># TODO: Rotate displacement to align with the initial local frame</span>
    <span class="c1"># This step is necessary to ensure the local coordinates are relative to the starting orientation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">local_x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">local_y</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</li>
<li><p><strong>Update the <code class="docutils literal notranslate"><span class="pre">control_loop</span></code> Method</strong> Finally, ensure that the <code class="docutils literal notranslate"><span class="pre">control_loop</span></code> method is updated to reflect the changes in the coordinate transformation.</p></li>
</ol>
</section>
<section id="build-and-test-the-package">
<h3><strong>Build and Test the Package</strong><a class="headerlink" href="#build-and-test-the-package" title="Link to this heading">#</a></h3>
<p>Let‚Äôs ensure your package is built and tested properly:</p>
<ol class="arabic">
<li><p><strong>Build the <code class="docutils literal notranslate"><span class="pre">lab7_tf</span></code> Package</strong>  Use the following command to build your package:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ccbuild<span class="w"> </span>--packages-select<span class="w"> </span>lab7_tf
</pre></div>
</div>
</li>
<li><p><strong>Demo the Robot</strong></p>
<ul class="simple">
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">move2goal_tf</span></code> node to demonstrate the robot moving to the goal location <code class="docutils literal notranslate"><span class="pre">(-0.61,</span> <span class="pre">0.61)</span></code> in meters and rotate the robot to face <code class="docutils literal notranslate"><span class="pre">0¬∞</span></code>.</p></li>
<li><p>Press Button Y to reset the pose and redo the previous task.</p></li>
</ul>
</li>
</ol>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bXpObdI8I-I?si=2L-dptYn9npyBbLc" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</center>
</section>
<hr class="docutils" />
<section id="deliverables">
<h3>üöö Deliverables<a class="headerlink" href="#deliverables" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>[20 Points] Complete the <code class="docutils literal notranslate"><span class="pre">move2goal_tf.py</span></code> Script</strong></p>
<ul class="simple">
<li><p>Ensure the script is fully functional and implements all required features.</p></li>
<li><p>Push your code to GitHub and confirm that it has been successfully uploaded.
<strong>NOTE:</strong> <em>If the instructor can‚Äôt find your code in your repository, you will receive a grade of 0 for the coding part.</em></p></li>
</ul>
</li>
<li><p><strong>[15 Points] Complete the <code class="docutils literal notranslate"><span class="pre">gamepad.py</span></code> Script</strong></p>
<ul class="simple">
<li><p>Ensure the script is fully functional and implements all required features.</p></li>
<li><p>Push your code to GitHub and confirm that it has been successfully uploaded.
<strong>NOTE:</strong> <em>If the instructor can‚Äôt find your code in your repository, you will receive a grade of 0 for the coding part.</em></p></li>
</ul>
</li>
<li><p><strong>[15 Points] Demonstration</strong></p>
<ul class="simple">
<li><p>Show the robot successfully navigating to the goal location and orientation in a real-world setup.</p></li>
</ul>
</li>
</ol>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Labs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Lab6_IMU.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">üî¨ Lab6: IMU-Based Navigation</p>
      </div>
    </a>
    <a class="right-next"
       href="Lab8_LIDAR.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">üî¨ Lab 8: LiDAR</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objectives">üìå Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">üìú Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-lab-testing-the-imu">üå± Pre-Lab: Testing the IMU</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-interactive-ssh-sessions">Non-Interactive SSH Sessions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-robot-launch-py-without-ssh-into-the-robot">Running <code class="docutils literal notranslate"><span class="pre">robot.launch.py</span></code> without SSH into the Robot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lab-procedure">üíª Lab Procedure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-new-ros2-package"><strong>Creating a New ROS2 Package</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-service-server"><strong>Implementing the Service Server</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-service-client"><strong>Implementing the Service Client</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-coordinate-transformation"><strong>Implement Coordinate Transformation</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-and-test-the-package"><strong>Build and Test the Package</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deliverables">üöö Deliverables</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Stan Baek
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>